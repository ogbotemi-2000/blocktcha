<!DOCTYPE html>
<html>
    <head>
        <title>Widget via Iframe</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/tailwind.min.css">
        <link rel="stylesheet" href="css/all.min.css">
        <link rel="stylesheet" href="css/page.css">
        <script src="js/ripples.js"></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/stellar-freighter-api/2.0.0/index.min.js'></script>
    </head>
    <body>

        <section class="inline-block relative p-5">
          <section class="show relative tooltip no-hover no-focus no-focus-within -slide-y" id="app">
            <form target="xhr" onsubmit="return false;" method="POST" action="/api/confirm">
              <label class="relative inline-block">
                  <i class="absolute text-5xl pointer-events-none right-0 text-gray-200 0 fa fa-key"></i>
                  <p class="text-sm inline-block font-semibold relative">Public key: starts with `G` and is 56 characters long</p>
                  <input name="pid" class="text-sm bg-transparent relative w-full p-2 placeholder-gray-400 outline-none border-b-2 border-gray-400" placeholder="If already copied, we'll try to paste it when you type" maxlength="56">
              </label>
              <button class="hover:bg-purple-100 mt-3 relative rounded-full p-0">
                  <div class="absolute h-full w-full rounded-inherit bg-gray-700 m-1"></div>
                  <div class="ripple relative p-2 px-3 rounded-inherit border-2 border-gray-700 bg-white">submit</div>
              </button>
          </form>

        </section>
        <aside id="alt" class="rounded-lg to-white inset-0 absolute backdrop-filter backdrop-blur-sm tooltip no-hover no-focus no-focus-within slide-y">
          <aside class="rounded-xl bg-gradient-to-r from-purple-500 via-purple-500 to-green-400 opacity-40 absolute inset-0 pointer-events-none z-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="absolute inset-0" width="100%" height="100%">
              <filter id="noise" x="0" y="0">
              <feTurbulence type="fractalNoise" baseFrequency="0.4" numOctaves="1" stitchTiles="stitch"></feTurbulence>
              <feBlend mode="screen"></feBlend>
              </filter>
              <rect width="100%" height="100%" filter="url(#noise)" opacity="0.9"></rect>
            </svg></aside>
            <section class="w-2/3 m-auto h-auto mt-8"><h3 class="font-fredoka">Freighter wallet detected</h3><hr class="border-current"><p class="mt-1.5 text-sm relative z-1">This overlay disappears when you are done with your transaction in the wallet extension</p></section>
          <div class="text-right pr-10">
                <button class="p-1 rounded-full relative">
                <div class="absolute border-r-0 border-2 border-current inset-0 right-1/2 rounded-l-full mr-0.5"></div>
                <div class="absolute border-l-0 border-2 border-current inset-0 left-1/2 rounded-r-full ml-0.5"></div>
                <div class="px-4 relative p-2 hover:bg-purple-700 hover:text-white duration-300 ease-out ripple rounded-inherit">
                  <i class="fa fa-wallet mr-2"></i> open wallet</div></button>
                </div>
              </aside>
    </section>

    </div> 

        <iframe id="xhr" class="mt-3 rounded-xl border border-gray-700 w-full" onload="let txt=['textContent', 'innerHTML'].map(p=>this.contentWindow.document.body[p]); if((txt=txt.filter(e=>e)).length) receive(txt)/*has content*/"></iframe>
        <script>
          /*use code from freighterApi codebase to detect if freighter wallet is available*/
          window.postMessage({source:"FREIGHTER_EXTERNAL_MSG_REQUEST", messageId:Date.now()+Math.random(), msg:{type:"REQUEST_CONNECTION_STATUS"/*"REQUEST_PUBLIC_KEY"*/}}, window.location.origin),
          new Promise(resolve=>{
            let timeout=0, onMessage=(event, data)=>{
              data = event.data;
              console.log("::FREIGHTER::EVENT", event);
              if(event.source!==window) return; // only accept if data is from own initiator above 
              if (event?.data?.source !== "FREIGHTER_EXTERNAL_MSG_RESPONSE") return; //only confirm presence if it matches constant
              resolve({isConnected:true, data}), clearTimeout(timeout),
              window.removeEventListener('message', onMessage)
            };
            timeout=setTimeout(_=>{
              resolve({isConnected:false})
            }, 2000),
            window.addEventListener('message', onMessage, false)            
          }).then(obj=>{
            console.log('::FREIGHTER::', obj)
          });
          /*end of try out*/
          let struct  = {source:'frame'};
          window.onmessage = function(msg, data) {
            if((data=msg.data).source!=='parent') return;
          }
          window.addEventListener('DOMContentLoaded', _=>{
            animations.addRippleAnimations()
          })
          function receive(txts) {
            /*function to receive data passed to iframe via form in backwards-compatible AJAX fashion*/
            console.log(txts)
          }
          function toggleScopes() {
            [app, alt].forEach(e=>e.classList.toggle('show'))
          }
          window.freighterApi.isConnected().then(bool=>{
            console.log('::IS CONNECTED::', bool);
            // bool&&toggleScopes()
          })
        </script>
    </body>
</html>